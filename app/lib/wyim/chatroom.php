<?phpnamespace lib\wyim;use lib\models\User;use yii\extend\AdCommon;use lib\models\Channel;use Yii;class chatroom extends wy{    const LIST_CACHE = 'wy_chatroom_list_cache';    const MEMBER_CACHE = 'wy_chatroom_member_list_cache';    //创建聊天室    public static function create($creator, $name)    {        static::$url = 'https://api.netease.im/nimserver/chatroom/create.action';        $result = static::send([            'creator' => $creator,            'name' => $name,        ]);                if($result) {            return $result->chatroom;        } else {            return false;        }    }    //发送聊天室信息    public static function sendGift($roomid, User $userModel, $gift_type, $gift_number)    {        static::$url = 'https://api.netease.im/nimserver/chatroom/sendMsg.action';        $msgId = md5(AdCommon::randomkeys().time().mt_rand());        $result = static::send([            'roomid' => $roomid,            'msgId' => $msgId,            'fromAccid' => '13043434556',            'msgType' => 0,            'ext' => json_encode([                'type'=>'2',                'userinfo' => [                    'nickname' => $userModel->nickname,                    'vip' => $userModel->vip_type ? '1' : '0',                    'head' => \lib\nodes\UserNode::get_head_url($userModel->head),                ],                'result' => [                    'gift_type' => $gift_type,                    'gift_number' => $gift_number,                ]            ]),        ]);                if($result) {            return true;        } else {            return false;        }    }    //取聊天室信息    public static function get($roomid)    {        static::$url = 'https://api.netease.im/nimserver/chatroom/get.action';        $result = static::send([            'roomid' => $roomid,            'needOnlineUserCount' => 'true',        ]);        if($result) {            return $result->chatroom;        } else {            return false;        }    }    //分页获取成员列表    public static function membersByPage($roomid)    {        static::$url = 'https://api.netease.im/nimserver/chatroom/membersByPage.action';        $result = static::send([            'roomid' => $roomid,            'type' => 0,            'endtime' => 0,            'limit' => 10,        ]);        if($result) {            return $result->desc->data;        } else {            return false;        }    }    //刷新列表    public static function refurbish()    {        $page = 1;        $psize = 60;        while(true)        {            $data = Channel::find()                ->select('cid,roomid')                ->offset(($page-1)*$psize)                ->limit($psize)                ->asArray()                ->all();            if(!$data) {                break;            }            $cache = Yii::$app->getCache();            foreach($data as $row) {                $roominfo = static::get($row['roomid']);                if($roominfo)                {                    $cache->set(static::LIST_CACHE.$row['roomid'], ['onlineusercount'=>$roominfo->onlineusercount]);                }            }            $page++;        }    }    //取缓存在本机的直播信息    public static function getinfo($cid)    {        $cache = Yii::$app->getCache();        return $cache->get(static::LIST_CACHE.$cid);    }    //缓存聊天室前10个人    public static function addMember()    {    }}