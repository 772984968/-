<?phpnamespace lib\forms;use Yii;use lib\models\UserVerifyInfo;use yii\extend\AdCommon;use lib\models\User;use lib\traits\formEngineTrait;//验证信息表单class UserVerifyInfoForm extends \yii\base\Model{    use formEngineTrait;    public $iid;    public $target_id;    public $user_id;    public $relevance_id;    const STATUS_REFUSE = 1;    const STATUS_AGREE = 2;    const STATUS_DEFAULT = 0;       public function scenarios()    {        return [            'adduser' => [                'target_id',                'user_id',                'relevance_id',            ],            'delete' => [                'iid',                'user_id',            ],            'refuse' => [                'iid',                'user_id',            ],            'agree' => [                'iid',                'user_id',            ],            'addMemberToTeam'=>[                'target_id',                'user_id',                'relevance_id',            ],        ];    }    public function rules()    {        return [            [['iid', 'target_id', 'type', 'user_id'], 'required'],            [['iid', 'target_id', 'user_id', 'relevance_id'], 'integer'],            ['type', 'in', 'range' => [1]],        ];    }    public function attributeLabels()    {        return [        ];    }            //加好友    public function adduser()    {        if($this->validate())        {            return $this->add(\Config::SEND_ADD_BUDDY);        }    }    //缴请用户入群    public function addMemberToTeam() {        if($this->validate())        {            return $this->add(\Config::SEND_ADD_MEMBER_TO_TEAM);        }    }        //加群    public function addTeam()    {        if($this->validate())        {            return $this->add(\Config::SEND_ADD_TEAM);        }    }    //添加申请    public function add($sendType)    {        if(UserVerifyInfo::findOne([            'user_id' => $this->user_id,            'target_id' => $this->target_id,            'type' => $sendType,            'status' => static::STATUS_DEFAULT,            'is_ratify' => 0,        ])) {            $this->addError('iid', '申请已提交,请耐心等待!');            return false;        }        $t = Yii::$app->getDb()->beginTransaction();        $seldModel = new UserVerifyInfo();        $data = AdCommon::array_clear_null($this->attributes);        $data['type'] = $sendType;        $seldModel->attributes = $data;        if( !$seldModel->save() ) {            $t->rollBack();            $this->addError('iid', AdCommon::modelMessage($seldModel->errors));            return false;        }        $receiveModel = new UserVerifyInfo();        $receiveModel->target_id = $this->user_id;        $receiveModel->user_id = $this->target_id;        $receiveModel->relevance_id = $this->relevance_id ?? 0;        $receiveModel->is_ratify = 1;        $receiveModel->type = $sendType;        $receiveModel->link_id = $seldModel->iid;        if( !$receiveModel->save() ) {            $t->rollBack();            $this->addError('iid', AdCommon::modelMessage($receiveModel->errors));            return false;        }        $t->commit();               return $receiveModel->iid;    }    //删除    public function delete()    {        if($this->validate())        {            $UserVerifyInfo = UserVerifyInfo::findOne(['iid'=>$this->iid, 'user_id'=>$this->user_id]);            if($UserVerifyInfo){                return $UserVerifyInfo->delete();            }            return true;        }    }    //拒绝    public function refuse(){        if($this->validate())        {            $UserVerifyInfo = UserVerifyInfo::findOne(['iid'=>$this->iid, 'user_id'=>$this->user_id, 'status'=>0]);            if(!$UserVerifyInfo){                $this->addError('iid', '记录不存在!');                return false;            }            if(!$UserVerifyInfo->is_ratify){                $this->addError('iid', '您是申请者,不能处理!');                return false;            }            //修改记录状态            $t = Yii::$app->getDb()->beginTransaction();            $UserVerifyInfo->status = static::STATUS_REFUSE;            if(!$UserVerifyInfo->save()) {                $this->addError('iid', Yii::t('common','fail'));                $t->rollBack();                return false;            }            //修改关联记录状态            $sourceInfo = UserVerifyInfo::findOne( $UserVerifyInfo->link_id );            if($sourceInfo)            {                $sourceInfo->status = static::STATUS_REFUSE;                if(!$sourceInfo->save()) {                    $this->addError('iid', Yii::t('common','fail'));                    $t->rollBack();                    return false;                }            }            $t->commit();            //发送信息            switch($UserVerifyInfo->type)            {                case \Config::SEND_ADD_BUDDY:                    $buddyForm = new BuddyForm();                    $buddyForm->setScenario('refuseAdd');                    $buddyForm->user_id = $UserVerifyInfo->user_id;                    $buddyForm->buddy_id = $UserVerifyInfo->target_id;                    $buddyForm->refuseAdd();                    break;                case \Config::SEND_ADD_TEAM:                    $buddyForm = new TeamForm();                    $buddyForm->setScenario('refuseAdd');                    $buddyForm->tid = $UserVerifyInfo->relevance_id;                    $buddyForm->user_id = $UserVerifyInfo->target_id;                    $buddyForm->refuseAdd();                    break;                case \Config::SEND_ADD_MEMBER_TO_TEAM:                    $buddyForm = new TeamForm();                    $buddyForm->setScenario('refuseAdd');                    $buddyForm->tid = $UserVerifyInfo->relevance_id;                    $buddyForm->user_id = $UserVerifyInfo->target_id;                    $buddyForm->memberRefuseAdd();                    break;            }            return true;        }    }    //同意    public function agree(){        if($this->validate())        {            $UserVerifyInfo = UserVerifyInfo::findOne(['iid'=>$this->iid, 'user_id'=>$this->user_id, 'status'=>0]);            if(!$UserVerifyInfo){                $this->addError('iid', '记录不存在!');                return false;            }            if(!$UserVerifyInfo->is_ratify){                $this->addError('iid', '您是申请者,不能处理!');                return false;            }            //修改记录状态为通过            $UserVerifyInfo->status = static::STATUS_AGREE;            $t = Yii::$app->getDb()->beginTransaction();            if(!$UserVerifyInfo->save()) {                $t->rollBack();                $this->addError('iid', Yii::t('common','fail'));                return false;            }            //修改关联记录状态            $sourceInfo = UserVerifyInfo::findOne( $UserVerifyInfo->link_id );            if($sourceInfo)            {                $sourceInfo->status = static::STATUS_AGREE;            }            else            {                $sourceInfo = new UserVerifyInfo();                $sourceInfo->user_id = $UserVerifyInfo->target_id;                $sourceInfo->target_id = $UserVerifyInfo->user_id;                $sourceInfo->relevance_id = $UserVerifyInfo->relevance_id;                $sourceInfo->status = static::STATUS_AGREE;            }            switch ($UserVerifyInfo->type)            {                case \Config::SEND_ADD_BUDDY:                    $sourceInfo->type = \Config::SEND_ADD_BUDDY;                    if(!$sourceInfo->save()) {                        $this->addError('iid', Yii::t('common','fail'));                        $t->rollBack();                        return false;                    }                    //添加好友                    $buddyForm = new BuddyForm();                    $buddyForm->setScenario('agreeAdd');                    $buddyForm->user_id = $UserVerifyInfo->user_id;                    $buddyForm->buddy_id = $UserVerifyInfo->target_id;                    if(!$buddyForm->agreeAdd()) {                        $t->rollBack();                        $this->addError('iid', '好友添加失败请稍后再试!');                        return false;                    }                    break;                case \Config::SEND_ADD_TEAM:                    $sourceInfo->type = \Config::SEND_ADD_TEAM;                    if(!$sourceInfo->save()) {                        $this->addError('iid', Yii::t('common','fail'));                        $t->rollBack();                        return false;                    }                    //加群                    $buddyForm = new TeamForm();                    $buddyForm->setScenario('agreeAdd');                    $buddyForm->user_id = $UserVerifyInfo->target_id;                    $buddyForm->tid = $UserVerifyInfo->relevance_id;                    if(!$buddyForm->agreeAdd()) {                        $t->rollBack();                        $this->addError('iid', '同意加群失败!');                        return false;                    }                    break;                case \Config::SEND_ADD_MEMBER_TO_TEAM:                    $sourceInfo->type = \Config::SEND_ADD_TEAM;                    if(!$sourceInfo->save()) {                        $this->addError('iid', Yii::t('common','fail'));                        $t->rollBack();                        return false;                    }                    //加群                    $buddyForm = new TeamForm();                    $buddyForm->setScenario('agreeAdd');                    $buddyForm->user_id = $UserVerifyInfo->user_id;                    $buddyForm->tid = $UserVerifyInfo->relevance_id;                    if(!$buddyForm->memberAgreeAdd()) {                        $t->rollBack();                        $this->addError('iid', '加群失败!');                        return false;                    }                    break;                default:                    $t->rollBack();                    $this->addError('iid', '没有这项信息类型!');                    return false;            }            $t->commit();            return true;        }    }    //常量意思    public static function constMeaning()    {        return [            static::STATUS_AGREE => '已通过',            static::STATUS_REFUSE => '已通过',            static::STATUS_DEFAULT => '等待对方同意',        ];    }            public function getList($isNext=0)    {        $data = UserVerifyInfo::list(['user_id'=>$this->user_id], $isNext,['userinfo','teaminfo']);        if($data)        {            $constMeaning = \Config::typeMeaning();            foreach($data as $key => $row) {                $row['title'] = $constMeaning[$row['type']] ?? '';                if($row['type']==3 && $row['is_ratify']==0 || $row['type']==4 && $row['is_ratify']==1) {                    $row['name'] = $row['teaminfo']['name'] ?? '';                    $row['head'] = $row['teaminfo']['icon'] ? \lib\nodes\UserNode::get_head_url($row['teaminfo']['icon']) : '';                } else {                    $row['name'] = $row['userinfo']['nickname'] ?? '';                    $row['head'] = $row['userinfo']['head'] ? \lib\nodes\UserNode::get_head_url($row['userinfo']['head']) : '';                }                unset($row['userinfo']);                unset($row['teaminfo']);                $data[$key] = $row;            }        }        return $data;    }    }