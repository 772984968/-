<?phpnamespace lib\forms;use lib\models\TeamMember;use Yii;use lib\models\Team;use yii\extend\AdCommon;use lib\models\User;use lib\wyim\wyim;class TeamForm extends CaptchaForm{    public $icon;    public $user_id;    public $name;    public $tid;    public $member_id;    public $members;    public function scenarios()    {        return [            'create' => [                'user_id',                'icon',                'name',            ],            'kick' => [                'user_id',                'member_id',                'tid',            ],            'apply' => [                'user_id',                'tid'            ],            'refuseAdd' => [                'user_id',                'tid',            ],            'agreeAdd' => [                'user_id',                'tid',            ],            'add' => [                'user_id',                'tid',                'member_id',            ],        ];    }    public function rules()    {        return [            [['user_id', 'name', 'tid', 'member_id'], 'required'],            [['user_id', 'tid', 'member_id'], 'integer'],            [['name'], 'string', 'max'=>20],            ['icon', 'validateIcon'],        ];    }    public function validateIcon($attraname, $params) {          $this->icon =  UploadForm::savebase64($this->icon);    }    //创建群聊    public function create()    {        if($this->validate())        {            $userModel = User::findOne($this->user_id);            $data = [                'tname' => $this->name,                'owner' => $userModel->wy_accid,                'members' => json_encode([$userModel->wy_accid]),                'msg' => '创建群',                'magree' => 0,                'joinmode' => 1,                'icon' => $this->icon ?? '',            ];            $wy_tid = wyim::createTeam($data);            if(!$wy_tid){                $this->addError('iid', wyim::$error);                return false;            }            //创建群,            $team_id = Team::add([                'user_id' => $this->user_id,                'name' => $this->name,                'icon' => $this->icon,                'wy_tid' => '111',                'member_number' => 1,            ]);                        if(!$team_id) {                $this->addError('iid', '群创建失败');                return false;            }            //添加群成员            TeamMember::add([                'user_id' => $this->user_id,                'team_id' => $team_id,            ]);            return ['wy_tid'=>$wy_tid];        }    }    //踢人出群    public function kick()    {        if($this->validate())        {            $userModel = User::findOne($this->user_id);            $memberModel = User::findOne($this->member_id);            if(!$memberModel) {                $this->addError('iid', '该用户不在群里面');                return false;            }            $teamModel = Team::findOne(['iid'=>$this->tid, 'user_id'=>$this->user_id]);            if(!$teamModel) {                $this->addError('iid', '群不存在');                return false;            }            $teamMemberModel = TeamMember::findOne(['user_id'=>$this->member_id, 'team_id'=>$this->tid]);            if(!$teamMemberModel) {                $this->addError('iid', '该用户不在群中');                return false;            }            $data = [                'tid' => $teamModel->wy_tid,                'owner' => $userModel->wy_accid,                'member' => $memberModel->wy_accid,            ];            $result = wyim::kickTeam($data);            if($result) {                $teamMemberModel->delete();                return true;            } else {                $this->addError('iid', wyim::$error);                return false;            }        }    }    //申请入群    public function apply()    {        if($this->validate())        {            if(TeamMember::inTeam($this->user_id, $this->tid)) {                $this->addError('iid', '您已经加入该群了');                return false;            }            $teamModle= Team::findOne($this->tid);            if(!$teamModle) {                $this->addError('iid', '群不存在!');                return false;            }            $userModle = User::findOne($teamModle->user_id);            //添加到数据库            $infoForm = new UserVerifyInfoForm();            $infoForm->setScenario('adduser');            $infoForm->user_id = $this->user_id;            $infoForm->target_id = $userModle->iid;            $infoForm->relevance_id = $this->tid;            $result = $infoForm->addTeam();            if(!$result) {                $this->addError('iid', AdCommon::modelMessage($infoForm->errors));                return false;            }            $appyUserModle = User::findOne($this->user_id);            //向网易发送信息            $data = [                'title' => '申请入群',                'type' => 'team',                'operate' => 'apply',                'head' => $appyUserModle->head,                'name' => $appyUserModle->nickname,                'iid' => $result,            ];            \lib\nodes\Notice::send($userModle->wy_accid, $data);            return true;        }    }    //同意添加    public function agreeAdd() {        if($this->validate())        {            $userModel = User::findOne($this->user_id);            $TeamModel = Team::findOne($this->tid);            $TeamMasterModel = User::findOne($TeamModel->user_id);            if(!$TeamModel) {                $this->addError('iid', '群不存在 !');                return false;            }            if(TeamMember::findOne(['user_id'=>$this->user_id, 'team_id'=>$this->tid])) {                $this->addError('iid', '该用户已加入群!');                return false;            }            //发送网易信息            $data = [                'tid' => $TeamModel->wy_tid,                'owner' => $TeamMasterModel->wy_accid,                'members' => json_encode([$userModel->wy_accid]),                'magree' => 0,                'msg' => '成功加入'.$TeamMasterModel->name.'群',            ];            if(wyim::addUserToTeam($data)) {                //添加到数据库中                if(!TeamMember::add([                    'user_id' => $this->user_id,                    'team_id' => $this->tid,                ])){                    $this->addError('iid', '入群失败');                    return false;                }                $TeamModel->member_number++;                $TeamModel->save();                \lib\nodes\Notice::send($userModel->wy_accid, $data = [                    'title' => '加群成功',                    'type' => 'team',                    'operate' => 'agree',                    'head' => $TeamModel->icon,                    'name' => $TeamModel->name,                ]);                return true;            } else {                $this->addError('iid', wyim::$error);                return false;            }        }    }    //拒绝添加    public function refuseAdd() {        if($this->validate())        {            $TeamModel = Team::findOne($this->tid);            $UserModel = User::findOne(['iid'=>$this->user_id]);            if(!$TeamModel) {                $this->addError('iid', '该群不存在 !');                return false;            }            //发送网易信息            \lib\nodes\Notice::send($UserModel->wy_accid, $data = [                'title' => '拒绝加群',                'type' => 'team',                'operate' => 'refuse',                'icon' => $TeamModel->icon,                'name' => $TeamModel->name,            ]);            return true;        }    }    //拒绝缴请    public function memberRefuseAdd()    {        if($this->validate())        {            $UserModel = User::findOne(['iid'=>$this->user_id]);            //发送网易信息            \lib\nodes\Notice::send($UserModel->wy_accid, $data = [                'title' => '拒绝加群',                'type' => 'team',                'operate' => 'memberrefuse',                'icon' => $UserModel->head,                'name' => $UserModel->nickname,            ]);            return true;        }    }        //同意缴请    public function memberAgreeAdd()    {        $userModel = User::findOne($this->user_id);        $TeamModel = Team::findOne($this->tid);        $TeamMasterModel = User::findOne($TeamModel->user_id);        if(!$TeamModel) {            $this->addError('iid', '群不存在 !');            return false;        }        if(TeamMember::findOne(['user_id'=>$this->user_id, 'team_id'=>$this->tid])) {            $this->addError('iid', '该用户已加入群!');            return false;        }        //发送网易信息        $data = [            'tid' => $TeamModel->wy_tid,            'owner' => $TeamMasterModel->wy_accid,            'members' => json_encode([$userModel->wy_accid]),            'magree' => 0,            'msg' => '成功加入'.$TeamMasterModel->name.'群',        ];        if(wyim::addUserToTeam($data)) {            //添加到数据库中            if(!TeamMember::add([                'user_id' => $this->user_id,                'team_id' => $this->tid,            ])){                $this->addError('iid', '入群失败');                return false;            }            $TeamModel->member_number++;            $TeamModel->save();            \lib\nodes\Notice::send($TeamMasterModel->wy_accid, $data = [                'title' => '加群成功',                'type' => 'team',                'operate' => 'memberagree',                'head' => $userModel->head,                'name' => $userModel->nickname,            ]);            return true;        } else {            $this->addError('iid', wyim::$error);            return false;        }    }    //缴请人入群    public function add()    {        if($this->validate())        {            if(TeamMember::inTeam($this->member_id, $this->tid)) {                $this->addError('iid', '该用户已经加入群了');                return false;            }            $teamModle = Team::findOne($this->tid);            if(!$teamModle) {                $this->addError('iid', '群不存在!');                return false;            }            $userModle = User::findOne($teamModle->user_id);            $memberModel = User::findOne($this->member_id);            if(!$memberModel) {                $this->addError('iid', '用户不存在!');                return false;            }            //添加验证信息            $infoForm = new UserVerifyInfoForm();            $infoForm->setScenario('addMemberToTeam');            $infoForm->user_id = $this->user_id;            $infoForm->target_id = $this->member_id;            $infoForm->relevance_id = $this->tid;            $result = $infoForm->addMemberToTeam();            if(!$result) {                $this->addError('iid', AdCommon::modelMessage($infoForm->errors));                return false;            }            //向网易发送信息            $data = [                'title' => '缴请入群',                'type' => 'team',                'operate' => 'add',                'icon' => $teamModle->icon,                'name' => $teamModle->name,                'iid' => $result,            ];            \lib\nodes\Notice::send($userModle->wy_accid, $data);            return true;        }    }}