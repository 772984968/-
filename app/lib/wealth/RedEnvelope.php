<?phpnamespace lib\wealth;use Yii;use lib\models\Setting;use lib\models\User;//红包类class RedEnvelope extends BaseWealth{    public  $userModel;    protected $fieldName = 'red_envelope';       //对应用户字段    protected $logClassName = '\lib\models\UserRedEnvelopeLog';    //对应的日志文件名    public $error = '';    const USER_RED_PERSON = 'user_red_person';//用户活动状态缓存    const USER_RED_ALL = 'user_red__all';//领取红包的所有用户    //红包转换为余额    public function toWallet($number, $note)    {        if($number < 0) {            $this->error = '参数不能为空';            return false;        }        $t = Yii::$app->getDb()->beginTransaction();        //减去现金红包        if(!$this->sub([            'number' => $number,            'type' => \Config::RED_ENVELOPE_CHANGE_WALLET,            'note' => $note,        ])) {            $t->rollBack();            return false;        }        //加人余额        $beansClass = Yii::$app->factory->getwealth('wallet', $this->userModel);        if(!$beansClass->add([            'number' => $number,            'type' => \Config::RED_ENVELOPE_CHANGE_WALLET,            'note' => $note,        ])) {            $t->rollBack();            return false;        }        $t->commit();        return true;    }    //注册红包    public  function register_red($row,User $UserModel){        $this->userModel=$UserModel;        $transaction =Yii::$app->getDb()->beginTransaction();        try {            if (!$this->toWallet($row['rewardNumber'], $row['name']))               throw new \Exception();            if (!$this->changestatus($row))                throw new \Exception();                $transaction->commit();            return true;        } catch (\Exception $e) {            $transaction->rollBack();            return false;        }    }    //修改用户活动状态    public function changestatus($activity) {                 Yii::$app->redis->sadd(static::USER_RED_ALL,static::USER_RED_PERSON.$this->userModel->iid);                return true;    }    //返回已领取红包个数    public static function user_red_all() {        return Yii::$app->redis->scard(static::USER_RED_ALL);    }}