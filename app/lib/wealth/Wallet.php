<?phpnamespace lib\wealth;use Yii;use lib\models\Setting;use lib\models\User;use lib\models\Agent;class Wallet extends BaseWealth{    protected $fieldName = 'wallet';       //对应用户字段    protected $logClassName = '\lib\models\UserWalletLog';    //对应的日志文件名    public $error = '';    //转换成钻石    public function toDiamond($number)    {        if(!$number) {            $this->error = '参数不能为空';            return false;        }        $t = Yii::$app->getDb()->beginTransaction();        //计算需要多少余额        $wallet_number = $number * 100 / Setting::keyTovalue('money2diamond');        //减去余额        if(!$this->sub([            'number' => $wallet_number,            'type' => \Config::DIAMOND_CHANGE_WALLET,        ])) {            $t->rollBack();            return false;        }        //加钻石        $diamondClass = Yii::$app->factory->getwealth('diamond', $this->userModel);        if(!$diamondClass->add([            'number' => $number,            'type' => \Config::DIAMOND_CHANGE_WALLET,        ])) {            $t->rollBack();            return false;        }        //推荐人奖励        if($this->userModel->inviteCode) {            $inviteUserModel = User::findByLlaccounts($this->userModel->inviteCode);            Yii::$app->factory->getwealth('diamond', $inviteUserModel)->add([                'number' => $number * Setting::keyTovalue('recommend_recharge_reward') / 100,                'type' => \Config::DIAMOND_RECHARGE_RECOMMEND,                'source_user_id' => $this->userModel->iid,                'note' => $this->userModel->username,            ]);        }        //代理人奖励        $agents = Agent::getCacheList();        $use_count = 0;        $agents_count = count($agents);        while($topuserModel = $this->userModel->getTop())        {            if($topuserModel->agent) {                $reward_number = 0;                $userAgent = Agent::getCacheRow($topuserModel->agent);                foreach($agents as $agent) {                    if($userAgent['label'] >= $agent['label'] && !isset($agent['use'])) {                        $reward_number += $number * $agent['recharge_reward'] / 100;                        $agent['use'] = 1;                        $use_count++;                    }                }                if($reward_number) {                    Yii::$app->factory->getwealth('diamond', $topuserModel)->add([                        'number' => $reward_number,                        'type' => \Config::DIAMOND_RECHARGE_AGENT,                        'source_user_id' => $this->userModel->iid,                        'note' => $this->userModel->username,                    ]);                }                //所有奖都拿完了                if($use_count >= $agents_count) {                    break;                }            }        }        $t->commit();        return true;    }    public function add( $data ){        if(parent::add($data)) {            Notice::send($this->userModel->wy_accid,[                'title' => \Config::walletLogMeaning()[$data['type']] ?? '',                'time' => date('Y-m-d H:i:s'),                'content' => $data['number'].'元',                'describe' => []            ]);            return true;        } else {            return false;        }    }    public function sub( $data ) {        if(parent::sub($data)) {            Notice::send($this->userModel->wy_accid,[                'title' => \Config::walletLogMeaning()[$data['type']] ?? '',                'time' => date('Y-m-d H:i:s'),                'content' => '-'.$data['number'].'元',                'describe' => []            ]);            return true;        } else {            return false;        }    }}