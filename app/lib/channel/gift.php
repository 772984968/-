<?phpnamespace lib\channel;use lib\models\Gift as GiftModel;use lib\models\Channel;use lib\wyim\chatroom;use lib\models\User;use Yii;class gift{    public static $error;    public static function send($userId, $receiverId, $payType, $payNumber)    {        $gift = GiftModel::getCacheRow($payType);                //礼物是否存在        if(!$gift) {            static::$error = '礼物不存在';            return false;        }        if($payNumber < 1) {            static::$error = '礼物数量不能小于1';            return false;        }        $ChannelModel = Channel::findOne(['user_id'=>$receiverId]);        //取主播间        if(!$ChannelModel) {            static::$error = '主播间不存在';            return false;        }        //取用户        $userModel = User::findOne($userId);        if(!$userModel) {            static::$error = '用户不存在';            return false;        }        //计算数量        $diamond_number = $gift['diamond'] * $payNumber;        if($diamond_number <= 0) {            static::$error = '要扣除的钻石数量不正确';            return false;        }        //取可以拿到的比例        $send_gify_scale = \lib\models\Setting::keyTovalue('send_gify_scale');        $receive_number = round($diamond_number * $send_gify_scale / 100, 2);        //取接收者        if(!$receiverId) {            static::$error = '接收人参数错误';            return false;        }        $receiverModel = User::findOne($receiverId);        if(!$receiverModel) {            static::$error = '接收人不存在';            return false;        }        $t = Yii::$app->getDb()->beginTransaction();        //减去相应的钻石        $diamondClass = Yii::$app->factory->getwealth('diamond', $userModel);        if(!$diamondClass->sub([            'type' => \Config::DIAMOND_SEND_GIFY,            'number' => $diamond_number,            'note' => '赠送'.$payNumber.$gift['name']        ])){            $t->rollBack();            static::$error = $diamondClass->error;            return false;        }        //接收人增加收益        if(!Yii::$app->factory->getwealth('diamond', $receiverModel)->add([            'type' => \Config::DIAMOND_SEND_GIFY,            'number' => $receive_number,            'note' => '赠送'.$payNumber.$gift['name']        ])) {            static::$error = '赠送礼物失败';            $t->rollBack();            return false;        };        //添加到赠送礼物日志        $gifyLogModel = new \lib\models\GifyLog();        $gifyLogModel->attributes = [            'user_id' => $userId,            'receiver_id' => $receiverId,            'gify_name' => $gift['name'],            'gify_number' => $payNumber,            'gify_price' => $diamond_number,            'scale' => $send_gify_scale,            'price' => $receive_number,        ];        if(!$gifyLogModel->save()) {            static::$error = '记录添加失败';            $t->rollBack();            return false;        }        $t->commit();        //计入到排名        \lib\channel\liveTelecastRanking::addDiamond($receiverId, $receive_number);        //发送群消息        chatroom::sendGift($ChannelModel->roomid, $userModel, $payType-1, $payNumber);        return $userModel->diamond;    }}