<?phpnamespace lib\channel;use Yii;class Barrage{    public $userModel;    const CACHE_NAME = 'user_send_barrage_number_';    //发送弹幕    public function send($roomid, $content)    {        //取用户会员权限        $member_power = $this->userModel->getMemberPower();        $number = $member_power['barrage'] ?? 0;        if($number && $this->surplus_number()) {            //发弹幕            $rst = \lib\wyim\chatroom::sendGift($roomid, $this->userModel, ['content'=>$content], 5);            if($rst) {                $this->addnumber();            } else {                throw new \Exception(\lib\wyim\chatroom::$error);            }        } else {            if($this->userModel->diamond > 1) {                //发弹幕                $rst = \lib\wyim\chatroom::sendGift($roomid, $this->userModel, ['content'=>$content], 5);            } else {                throw new \Exception('钻石数量不足');            }            if( $rst) {                Yii::$app->factory->get('diamond', $this->userModel)->sub([                    'number' => 1,                    'type' => \Config::DIAMOND_BARRAGE,                ]);            } else {                throw new \Exception(\lib\wyim\chatroom::$error);            }        }        return $rst;    }    //用户剩余的免费,弹幕数量    public function surplus_number()    {        $member_power = $this->userModel->getMemberPower();        $number = $member_power['barrage'] ?? 0;        return $number ? $number - $this->getnumber() : $number;    }    //添加发送记录数    private function addnumber()    {        $redis = Yii::$app->redis;        $keyname = static::CACHE_NAME.$this->userModel->iid;        if($redis->EXISTS($keyname)) {            $redis->INCR($keyname);        } else {            $ex_time = 86400-(time()-strtotime(date('Y-m-d')));            $redis->SETEX($keyname, $ex_time, 1);        }    }    //取发送记录数    private function getnumber()    {        return Yii::$app->redis->get(static::CACHE_NAME.$this->userModel->iid) ?? 0;    }}