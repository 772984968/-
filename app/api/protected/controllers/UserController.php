<?phpnamespace api\controllers;use yii\extend\AdCommon;use lib\forms\UserForm;use lib\models\User;use lib\models\UserWithdrawDeposit;use Yii;use lib\nodes\UserMessage;use yii\VideoCloud\Storage\UploadManager;use lib\wealth\Credits;use lib\models\AccountLevel;class UserController extends BasisController{    //注册    public function actionRegister()    {       parent::baseAction('\lib\forms\UserForm', 'register');    }    //登入    public function actionLogin()    {        parent::baseAction('\lib\forms\UserForm', 'login');    }    //修改密码    public function actionChangepassword()    {        parent::baseAction('\lib\forms\UserForm', 'changepassword');    }    //退出    public function actionLogout()    {        if( HUANG_JING == 1 ) {            Yii::$app->factory->getuser()->logout();            $this->success();        } else {            Yii::$app->getSession()->destroy();            $this->success();        }    }    //更新信息    public function actionUpdateinfo()    {        parent::baseAction('\lib\forms\UserForm', 'updateinfo');    }    /**     * @author li     * 短信取回密码     */    public function actionMsgpassword(){         parent::baseAction('\lib\forms\UserForm', 'msgpassword');    }    /**     * @author li     * 用户签到     */    public function actionSign(){       $creditsClass=\Yii::$app->factory->getCredits();       if ($creditsClass->sign()){           $this->success();          }else{              $this->error($creditsClass->error);          }    }    /**     *@author li     *取用户签到信息     */    public function actionGetsign(){        $user_id=\Yii::$app->factory->getuser()->userId;        $year=Yii::$app->request->post('year');        $month=Yii::$app->request->post('month');        $signModel=new \lib\models\Sign();        $data=$signModel->signlist($user_id,$year,$month);        if ($data){            $this->success($data);        }else{                $this->error('该用户无任何签到信息');        }    }    /**     *@author li     *取用户等级信息     */    public function actionGetlevel(){        $credits=Yii::$app->factory->getuser()->credits;        $data['level']=AccountLevel::getLevel($credits);        $data['live_proportion']=AccountLevel::liveearn($credits)*100;        $data['diamond_proportion']=AccountLevel::diamondWithdraw($credits)*1000;        $ratio=AccountLevel::classrate($credits);        $data['ratio']=$ratio['classrate'];        $data['next_credits']=$ratio['next_credits'];        $data['credits']=$credits;        return $this->success($data);    }    //取用户信息    public function actionGetinfo()    {        $id = Yii::$app->getRequest()->post('id');        if($id) {            $result = Yii::$app->factory->createuser($id)->getinfo();            if($result)            {                $user_id = Yii::$app->factory->getuser()->userId;                $is_buddy = \lib\models\Buddy::findOne(['user_id'=>$user_id, 'buddy_id'=>$id]) ? '1' : '0';                $result['mutual'] = \lib\models\Fans::findOne(['user_id'=>$id, 'fans_id'=>$user_id]) ? '1' : '0';            }        } else {            $is_buddy = '0';            $result = Yii::$app->factory->getuser()->getinfo();            if($result)            {                $result['mutual'] = '0';            }        }        if($result) {            $result['is_buddy'] = $is_buddy;            $this->success($result);        } else {            $this->error('没有资料');        }    }    //设置缴请码    public function actionSetinvitecode() {        $code = Yii::$app->getRequest()->post('code');        if(!$code) {            $this->error('请输入缴请码!');        }        $iModel = User::findOne(['llaccounts'=>$code]);        if(!$iModel) {            $this->error('缴请码输入有误!');        }        $userId = Yii::$app->factory->getuser()->userId;        $userModel = User::findOne($userId);        if($userModel->inviteCode) {            $this->error('您已经设置了缴请码!');        }        if($userModel->llaccounts == $code) {            $this->error('缴请码不能输入自己的帐号!');        }        if($iModel->iid > $userModel->iid) {            $this->error('您的帐号比缴请人还先创建');        }        $userModel->inviteCode = $code;        if($userModel->save()) {            $this->success();        } else {            $this->error('错误,请稍候再试!');        }    }    //保存base64图片    public function actionUploadbase64()    {        $content = Yii::$app->getRequest()->post('content');        if($content) {            $this->success(['url'=>\lib\forms\UploadForm::savebase64($content)]);        } else {            $this->error('没有内容');        }    }    //搜索帐号    public function actionFind() {        $keyword = Yii::$app->getRequest()->post('keyword');        if(!$keyword) {            $this->error('请输入关键字!');        }        $page = AdCommon::pageget(20,20);        $usernameResult = User::find()            ->select('iid,head,nickname,llaccounts,wy_accid')            ->where("username LIKE :keyword OR nickname LIKE :keyword OR llaccounts LIKE :keyword",[':keyword'=>"$keyword%"]);        $rowcount = $usernameResult->count();        $count = $rowcount ? ceil($rowcount/$page['pagesize']) : 0;        $result = $usernameResult->offset($page['start'])->limit($page['pagesize'])->asArray()->all();        foreach($result as $key => $row) {            $result[$key]['head'] = \lib\nodes\UserNode::get_head_url($row['head']);        }        if($result) {            $this->success(['page'=>$page['page'],'count'=>$count,'list'=>$result]);        } else {            $this->error('用户不存在');        }    }    //验证用户token    public function actionCheckToken()    {        $userid = Yii::$app->getRequest()->get('userid');        $token = Yii::$app->getRequest()->get('token');        if(Yii::$app->getCache()->get('token_'.$userid) == $token) {            $this->success();        } else {            $this->error('error');        }    }    //取信息发给用户的信息    public function actionMessage()    {        $rst = UserMessage::get(Yii::$app->factory->getuser()->userId);        if($rst) {            $this->success($rst);        } else {            $this->error('没有信息');        }    }}